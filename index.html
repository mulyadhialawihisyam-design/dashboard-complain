<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Komplain Shipment</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #0f1220;
            --bg-card: rgba(255, 255, 255, 0.06);
            --border-soft: rgba(255, 255, 255, 0.12);
            --text-main: #eaeaf0;
            --text-soft: #a8acc4;
            --accent: #7c7cff;
            --success: #4ade80;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --vibrant-blue: #3742fa;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: linear-gradient(160deg, #0b0e1a, #14183a); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }

        header { padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; }
        button.reload { background: var(--gradient-primary); border: none; color: #fff; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        button.reload:hover { transform: scale(1.05); }

        .container { padding: 0 24px 32px; flex: 1; }
        .grid-main { display: grid; grid-template-columns: 280px 1fr 1fr; gap: 16px; }
        .card { background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: 14px; padding: 16px; position: relative; }
        
        #employeeInput { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-soft); background: rgba(0, 0, 0, 0.4); color: white; margin-bottom: 15px; outline: none; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto 10px; border: 2px solid var(--accent); }
        .kpi { display: flex; justify-content: space-between; gap: 8px; margin-top: 15px; }
        .kpi div { text-align: center; flex: 1; padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.04); }
        .kpi strong { display: block; font-size: 18px; color: var(--accent); }

        .chart-wrap { height: 240px; width: 100%; position: relative; }

        .toast { position: fixed; top: 20px; right: 20px; background: #1e293b; color: white; padding: 12px 20px; border-radius: 10px; border-left: 4px solid var(--success); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 1000; display: none; align-items: center; gap: 10px; animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .filter-row { display: flex; gap: 12px; margin-bottom: 20px; }
        .filter-row select { background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-soft); color: #fff; padding: 8px 12px; border-radius: 8px; cursor: pointer; }

        .month-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .month-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-soft); border-radius: 12px; padding: 15px; }
        .month-card h4 { margin: 0 0 12px; padding: 6px; text-align: center; background: var(--vibrant-blue); border-radius: 6px; font-size: 14px; color: white; }

        .invoice-item { margin-bottom: 10px; padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.04); border-left: 3px solid transparent; transition: 0.2s; }
        .invoice-item:hover { background: rgba(124, 124, 255, 0.08); border-left-color: var(--accent); }
        .invoice-link { color: var(--accent); text-decoration: none; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        
        .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 8px; display: inline-block; }
        .status-terkirim { background: rgba(74, 222, 128, 0.1); color: var(--success); }
        .status-pending { background: rgba(255, 71, 87, 0.1); color: #ff4757; }

        footer { text-align: center; padding: 20px; color: var(--text-soft); font-size: 13px; border-top: 1px solid var(--border-soft); background: rgba(0,0,0,0.2); }

        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
        .loading.show { display: block; }
        .spinner { width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="toast" class="toast">
    <i class="fa fa-check-circle" style="color: var(--success)"></i>
    <span>Data berhasil dimuat!</span>
</div>

<header>
    <h1>Dashboard Komplain</h1>
    <div style="display:flex; gap:10px">
        <a href="https://mulyadhialawihisyam-design.github.io/Monitoring-Complain/" target="_blank" style="text-decoration:none; color:white; background:rgba(255,255,255,0.08); padding:10px 16px; border-radius:10px; font-size:14px;">
            <i class="fa fa-chart-line"></i> Monitoring
        </a>
        <button class="reload" id="reloadBtn"><i class="fa fa-rotate"></i> Reload Data</button>
    </div>
</header>

<div class="container">
    <div class="grid-main">
        <div class="card">
            <h3>Pilih PIC</h3>
            <input type="text" id="employeeInput" list="employeeList" placeholder="Cari Nama...">
            <datalist id="employeeList"></datalist>
            <div class="avatar" id="avatar">?</div>
            <div id="employeeName" style="text-align:center; font-weight:600; font-size: 18px;">---</div>
            <div class="kpi">
                <div><strong id="kpiTotal">0</strong><span style="font-size: 11px;">Total Kesalahan</span></div>
                <div><strong id="kpiInvoice">0</strong><span style="font-size: 11px;">Uniq Invoice</span></div>
            </div>
        </div>

        <div class="card">
            <h3>Distribusi Kasus</h3>
            <div class="chart-wrap">
                <div class="loading" id="pieLoading"><div class="spinner"></div></div>
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>Tren 3 Bulan Terakhir</h3>
            <div class="chart-wrap">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <div class="section-detail" style="margin-top: 35px;">
        <h2 style="font-size: 18px; margin-bottom: 15px;">Detail Komplain Tahunan</h2>
        <div class="filter-row">
            <select id="yearSelect"></select>
            <select id="monthSelect"><option value="all">Semua Bulan</option></select>
            <select id="statusSelect">
                <option value="all">Semua Status</option>
                <option value="Sudah Terkirim">Sudah Terkirim</option>
                <option value="Belum Terkirim">Belum Terkirim</option>
            </select>
        </div>
        <div class="month-grid" id="monthGrid"></div>
    </div>
</div>

<footer>Created by <strong>Mulya.ID</strong></footer>

<script>
const DATA_URL = 'https://script.google.com/macros/s/AKfycbyWBWuNZs9m3ixRZ6NUrEtX8pxhtdvPRmh5Yw_70J6GDdikF76QByva9zRB5mzA9plR/exec';
const MONTHS = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

let rawData = [];
let pieChart = null;
let barChart = null;
let selectedEmployee = '', selectedYear = '', selectedMonth = 'all', selectedStatus = 'all';

function showToast() {
    const toast = document.getElementById('toast');
    toast.style.display = 'flex';
    setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

async function loadData() {
    document.getElementById('pieLoading').classList.add('show');
    try {
        const res = await fetch(DATA_URL);
        const json = await res.json();
        const data = json.data || json.rows || json || [];
        
        rawData = data.map(r => ({
            ...r,
            pic: (r.pic_yang_melakukan_kesalahan || '').trim(),
            d: parseDate(r.tanggal),
            detail: r.detail_kesalahan || '',
            status: (r.status_terkirim || '').trim()
        })).filter(r => r.d && r.pic);

        populateEmployees();
        populateYears();
        populateMonths();
        showToast();
    } catch (e) { console.error(e); }
    finally { document.getElementById('pieLoading').classList.remove('show'); }
}

function parseDate(s) {
    if(!s) return null;
    const p = s.split('/');
    return new Date(p[2], p[1]-1, p[0]);
}

function populateEmployees() {
    const list = document.getElementById('employeeList');
    const pics = [...new Set(rawData.map(r => r.pic))].sort();
    list.innerHTML = pics.map(p => `<option value="${p}">`).join('');
}

function populateYears() {
    const years = [...new Set(rawData.map(r => r.d.getFullYear()))].sort((a,b)=>b-a);
    const sel = document.getElementById('yearSelect');
    sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    selectedYear = years[0];
}

function populateMonths() {
    const sel = document.getElementById('monthSelect');
    MONTHS.forEach((m, i) => { sel.innerHTML += `<option value="${i}">${m}</option>`; });
}

document.getElementById('employeeInput').addEventListener('change', (e) => { selectedEmployee = e.target.value; update(); });
document.getElementById('yearSelect').addEventListener('change', (e) => { selectedYear = e.target.value; update(); });
document.getElementById('monthSelect').addEventListener('change', (e) => { selectedMonth = e.target.value; update(); });
document.getElementById('statusSelect').addEventListener('change', (e) => { selectedStatus = e.target.value; update(); });

function update() {
    if(!selectedEmployee) return;
    
    // 1. Filter dasar berdasarkan PIC dan Tahun
    const baseData = rawData.filter(r => r.pic === selectedEmployee && r.d.getFullYear() == selectedYear);
    
    // 2. Filter Detail (Sinkron dengan input filter Bulan & Status)
    const detailData = baseData.filter(r => {
        const matchMonth = selectedMonth === 'all' || r.d.getMonth() == selectedMonth;
        const matchStatus = selectedStatus === 'all' || r.status === selectedStatus;
        return matchMonth && matchStatus;
    });

    // 3. Update Profil & KPI (Dinamis sesuai filter)
    document.getElementById('employeeName').textContent = selectedEmployee;
    document.getElementById('avatar').textContent = selectedEmployee[0].toUpperCase();
    document.getElementById('kpiTotal').textContent = detailData.length;
    document.getElementById('kpiInvoice').textContent = new Set(detailData.map(r => r.invoice)).size;

    // 4. Update Visualisasi (Semua pakai detailData agar Dinamis!)
    renderPie(detailData); 
    renderBar(baseData); // Tren tetap baseData supaya perbandingan 3 bulan terakhir tetap kelihatan
    renderMonthlyDetail(detailData);
}

function renderPie(rows) {
    const counts = {};
    rows.forEach(r => counts[r.kasus] = (counts[r.kasus] || 0) + 1);
    
    const canvas = document.getElementById('pieChart');
    if(pieChart) pieChart.destroy();

    // Jika data kosong setelah difilter, jangan gambar chart
    if (rows.length === 0) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }

    pieChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: Object.keys(counts),
            datasets: [{ 
                data: Object.values(counts), 
                backgroundColor: ['#3742fa', '#7c7cff', '#f5576c', '#2ed573', '#ffa502'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: { 
                legend: { 
                    position: 'right', 
                    labels: { color: '#a8acc4', font: { size: 10 }, boxWidth: 10 } 
                } 
            }
        }
    });
}

// LOGIKA TREN 3 BULAN (REVISI 4)
function renderBar(rows) {
    const latestDate = new Date(Math.max(...rows.map(r => r.d)));
    const monthsToShow = [];
    
    for (let i = 2; i >= 0; i--) {
        let d = new Date(latestDate.getFullYear(), latestDate.getMonth() - i, 1);
        monthsToShow.push({
            monthIndex: d.getMonth(),
            year: d.getFullYear(),
            label: MONTHS[d.getMonth()],
            count: 0
        });
    }

    rows.forEach(r => {
        monthsToShow.forEach(m => {
            if (r.d.getMonth() === m.monthIndex && r.d.getFullYear() === m.year) {
                m.count++;
            }
        });
    });

    if (barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: monthsToShow.map(m => m.label),
            datasets: [{
                label: 'Jumlah Komplain',
                data: monthsToShow.map(m => m.count),
                backgroundColor: ['#4facfe', '#7c7cff', '#f5576c'],
                borderRadius: 8,
                barThickness: 30
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#a8acc4', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { ticks: { color: '#a8acc4' }, grid: { display: false } }
            }
        }
    });
}

function renderMonthlyDetail(rows) {
    const grid = document.getElementById('monthGrid');
    grid.innerHTML = '';
    const grouped = {};
    rows.forEach(r => {
        const m = r.d.getMonth();
        if(!grouped[m]) grouped[m] = [];
        grouped[m].push(r);
    });

    Object.keys(grouped).sort((a,b)=>b-a).forEach(m => {
        const card = document.createElement('div');
        card.className = 'month-card';
        card.innerHTML = `<h4>${MONTHS[m]} ${selectedYear}</h4>`;
        grouped[m].forEach(r => {
            const linkMatch = r.detail.match(/https?:\/\/[^\s|]+/g);
            const driveUrl = linkMatch ? linkMatch[0] : '#';
            const cleanText = r.detail.split('|')[0].replace(driveUrl, '').trim();
            const statusClass = r.status === 'Sudah Terkirim' ? 'status-terkirim' : 'status-pending';

            const item = document.createElement('div');
            item.className = 'invoice-item';
            item.innerHTML = `
                <a href="${driveUrl}" target="_blank" class="invoice-link">
                    <i class="fa fa-external-link-alt" style="font-size: 10px;"></i> ${r.invoice || 'N/A'}
                </a>
                <div style="font-size:12px; margin-top:4px; font-weight:500;">${r.kasus}</div>
                <div style="font-size:11px; color:var(--text-soft); margin-top:5px; font-style:italic;">${cleanText || 'Detail tidak tersedia'}</div>
                <div class="status-badge ${statusClass}">${r.status}</div>
            `;
            card.appendChild(item);
        });
        grid.appendChild(card);
    });
}

document.getElementById('reloadBtn').addEventListener('click', loadData);
loadData();
</script>
</body>
</html>
